<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBC for brms models • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SBC for brms models">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="brms_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SBC for brms models</h1>
                        <h4 class="author">Martin Modrák</h4>
            
            <h4 class="date">2021-09-17</h4>
      
      
      <div class="hidden name"><code>brms.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SBC</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>brms.backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span>
<span class="co"># options(brms.backend = "rstan") # Uncomment to use rstan instead</span>

<span class="co"># Using parallel processing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/future">future</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="co"># The fits are very fast,</span>
<span class="co"># so we force a minimum chunk size to reduce overhead of</span>
<span class="co"># paralellization and decrease computation time.</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>SBC.min_chunk_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># Setup caching of results</span>
<span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./brms_SBC_cache"</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Build a generator using brms and its <code>sample_prior = "only"</code> feature.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We need a "template dataset" to let brms build the model.</span>
<span class="co"># The predictor (x) values will be used for data generation,</span>
<span class="co"># the response (y) values will be ignored, but need to be present and </span>
<span class="co"># of the correct data type</span>
<span class="va">template_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span>
<span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>
<span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_brms.html">SBC_generator_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">template_data</span>, prior <span class="op">=</span> <span class="va">priors</span>, 
                                thin <span class="op">=</span> <span class="fl">50</span>, warmup <span class="op">=</span> <span class="fl">10000</span>, refresh <span class="op">=</span> <span class="fl">2000</span>,
                                <span class="co"># Will generate the log density - this is useful, </span>
                                <span class="co">#but a bit computationally expensive</span>
                                generate_lp <span class="op">=</span> <span class="cn">TRUE</span> 
                                <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">22133548</span><span class="op">)</span>
<span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator</span>, <span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code>## Running MCMC with 1 chain...
## 
## Chain 1 Iteration:     1 / 15000 [  0%]  (Warmup) 
## Chain 1 Iteration:  2000 / 15000 [ 13%]  (Warmup) 
## Chain 1 Iteration:  4000 / 15000 [ 26%]  (Warmup) 
## Chain 1 Iteration:  6000 / 15000 [ 40%]  (Warmup) 
## Chain 1 Iteration:  8000 / 15000 [ 53%]  (Warmup) 
## Chain 1 Iteration: 10000 / 15000 [ 66%]  (Warmup) 
## Chain 1 Iteration: 10001 / 15000 [ 66%]  (Sampling) 
## Chain 1 Iteration: 12000 / 15000 [ 80%]  (Sampling) 
## Chain 1 Iteration: 14000 / 15000 [ 93%]  (Sampling) 
## Chain 1 Iteration: 15000 / 15000 [100%]  (Sampling) 
## Chain 1 finished in 0.2 seconds.</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Reuse the compiled model and other info from the generator</span>
<span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms_from_generator.html">SBC_backend_brms_from_generator</a></span><span class="op">(</span><span class="va">generator</span>, chains <span class="op">=</span> <span class="fl">1</span>, thin <span class="op">=</span> <span class="fl">1</span>,
                            init <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>

<span class="co"># More verbose alternative that results in exactly the same backend:</span>
<span class="co"># backend &lt;- SBC_backend_brms(y ~ x, template_dataset = template_data, prior = priors, warmup = 500, iter = 1000, chains = 1, thin = 1</span>
<span class="co">#                            init = 0.1)</span></code></pre></div>
<p>Compute the actual results</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_results.html">compute_results</a></span><span class="op">(</span><span class="va">datasets</span>, <span class="va">backend</span>, thin_ranks <span class="op">=</span> <span class="fl">10</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"first"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Cache file exists but the backend hash differs. Will recompute.</code></pre>
<pre><code>##  - 13 (13%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.016.</code></pre>
<pre><code>##  - 66 (66%) fits had some steps rejected. Maximum number of rejections was 5.</code></pre>
<pre><code>## Not all diagnostics are OK. You can learn more by inspecting $default_diagnostics, $backend_diagnostics and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
<p>And show ecdf_diff plot - there are no big problems at this resolution.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_plots-2.png" width="700"></p>
<div id="using-custom-simulation-code" class="section level2">
<h2 class="hasAnchor">
<a href="#using-custom-simulation-code" class="anchor"></a>Using custom simulation code</h2>
<p>Let’s take a bit more complex model - with a single varying intercept.</p>
<p>This time we will not use the <code>brms</code> model to also simulate from prior, but simulate using an R function.</p>
<p>This allows us to have different covariate values for each dataset, potentially improving sensitivity.</p>
<p>Let’s take a Gaussian model with a single varying intercept.</p>
<p>The data can be generated using the following code:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_dataset_generator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">K</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># N - number of datapoints, K number of groups for the varying intercept</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fl">3</span> <span class="op">*</span> <span class="va">K</span> <span class="op">&lt;=</span> <span class="va">N</span><span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span>
  
  <span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, size <span class="op">=</span> <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="co"># Ensure all groups are actually present at least twice</span>
  <span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

  <span class="va">b_Intercept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>   
  <span class="va">b_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  
  <span class="va">sd_group__Intercept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
  <span class="va">r_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">0</span>, <span class="va">sd_group__Intercept</span><span class="op">)</span>, 
                 nrow <span class="op">=</span> <span class="va">K</span>, ncol <span class="op">=</span> <span class="fl">1</span>,
                 dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="st">"Intercept"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">predictor</span> <span class="op">&lt;-</span> <span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">b_x</span> <span class="op">+</span> <span class="va">r_group</span><span class="op">[</span><span class="va">group</span><span class="op">]</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">predictor</span>, <span class="va">sigma</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      b_Intercept <span class="op">=</span> <span class="va">b_Intercept</span>,
      b_x <span class="op">=</span> <span class="va">b_x</span>,
      sd_group__Intercept <span class="op">=</span> <span class="va">sd_group__Intercept</span>,
      r_group <span class="op">=</span> <span class="va">r_group</span>,
      sigma <span class="op">=</span> <span class="va">sigma</span>
    <span class="op">)</span>,
    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, group <span class="op">=</span> <span class="va">group</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">n_dataset_generator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">one_dataset_generator</span>, N <span class="op">=</span> <span class="fl">25</span>, K <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>For increased sensitivity, we also add the log likelihood of the data given parameters as a generated quantity that we’ll also monitor.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">log_lik_gq_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generated_quantities.html">generated_quantities</a></span><span class="op">(</span>
  log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">b_x</span> <span class="op">+</span> <span class="va">r_group</span><span class="op">[</span><span class="va">group</span><span class="op">]</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12239755</span><span class="op">)</span>
<span class="va">datasets_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">n_dataset_generator</span>, <span class="fl">100</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">priors_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.75</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>


<span class="va">backend_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms.html">SBC_backend_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,  
                            prior <span class="op">=</span> <span class="va">priors_func</span>, chains <span class="op">=</span> <span class="fl">1</span>,
                            template_dataset <span class="op">=</span> <span class="va">datasets_func</span><span class="op">$</span><span class="va">generated</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_results.html">compute_results</a></span><span class="op">(</span><span class="va">datasets_func</span>, <span class="va">backend_func</span>, thin_ranks <span class="op">=</span> <span class="fl">10</span>, 
                                gen_quants <span class="op">=</span> <span class="va">log_lik_gq_func</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"func"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Cache file exists but the backend hash differs. Will recompute.</code></pre>
<pre><code>##  - 27 (27%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 2.125.</code></pre>
<pre><code>##  - 3 (3%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing the rank statistics. The lowest tail ESS was NA.
##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_statistcs) or number of posterior samples (by refitting) might help.</code></pre>
<pre><code>##  - 27 (27%) fits had divergent transitions. Maximum number of divergences was 305.</code></pre>
<pre><code>##  - 84 (84%) fits had some steps rejected. Maximum number of rejections was 7.</code></pre>
<pre><code>## Not all diagnostics are OK. You can learn more by inspecting $default_diagnostics, $backend_diagnostics and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_func</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_func</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func_plots-2.png" width="700"></p>
<p>It looks like there is a problem affecting at least the <code>b_Intercept</code> and <code>sigma</code> parameters. We may also notice that the <code>log_lik</code> (log likelihood derived from all the parameters) is copying the behaviour of the worst behaving parameter. This tends to be the case in many models, so in models with lots of parameters, it can be useful to add such a term as they make noticing problems easier. There also other advantages as discussed in the <code>limits_of_SBC</code> vignette.</p>
<p>What happened is that <code>brms</code> by default centers all the predictors, which changes the numerical values of the intercept (but not other terms). The interaction with the prior than probably also affects the other parameters.</p>
<p>Maybe we don’t want <code>brms</code> to do this — using <code>0 + Intercept</code> syntax avoids the centering.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Using 0 + Intercept also changes how we need to specify priors</span>
<span class="va">priors_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.75</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>


<span class="va">backend_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms.html">SBC_backend_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,  
                            prior <span class="op">=</span> <span class="va">priors_func2</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, iter <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">1</span>,
                            template_dataset <span class="op">=</span> <span class="va">datasets_func</span><span class="op">$</span><span class="va">generated</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>Let’s fit the same datasets with the new backend.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_results.html">compute_results</a></span><span class="op">(</span><span class="va">datasets_func</span>, <span class="va">backend_func2</span>, thin_ranks <span class="op">=</span> <span class="fl">10</span>, 
                                 gen_quants <span class="op">=</span> <span class="va">log_lik_gq_func</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"func2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Cache file exists but the backend hash differs. Will recompute.</code></pre>
<pre><code>##  - 20 (20%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.036.</code></pre>
<pre><code>##  - 10 (10%) fits had divergent transitions. Maximum number of divergences was 28.</code></pre>
<pre><code>##  - 88 (88%) fits had some steps rejected. Maximum number of rejections was 7.</code></pre>
<pre><code>## Not all diagnostics are OK. You can learn more by inspecting $default_diagnostics, $backend_diagnostics and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
<p>We see that this results in mostly non-problematic univariate checks.</p>
<p>TODO: Figure out the source of divergences and check if they create the mismatch for some of the parameters.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_func2</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func2_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_func2</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func2_plots-2.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Shinyoung Kim, Hyunji Moon, Martin Modrák.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
